generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

model Customer {
  id                  BigInt   @id @default(autoincrement())
  memberNo            String   @unique                     // numeric string used to login
  fullName            String?
  gender              String?
  idCardNumber        String?
  phoneNumber         String?
  locationType        String?                             // "Rural"/"Urban"
  villageName         String?                             // Ward/Village
  groupCode           String?
  groupName           String?
  branchCode          String? // CHANGED: branch code for RBAC filtering
  branchName          String? // CHANGED: branch display name from group mapping
  membershipStartDate DateTime?
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  lastSyncedAt        DateTime? // [BIJLI-CUSTOMER] cache sync timestamp

  credential     CustomerCredential?
  refreshTokens  RefreshToken[]
  loans          Loan[]
  savings        CustomerSavings[]
  savingsTransactions CustomerSavingsTransaction[] // CHANGED: lưu lịch sử giao dịch tiết kiệm
  feedbacks      Feedback[]

  @@index([branchCode, groupCode]) // CHANGED: optimize branch + group filters
}

model CustomerCredential {
  customerId         BigInt  @id
  passwordHash       String
  mustChangePassword Boolean @default(true)
  passwordUpdatedAt  DateTime?
  lastLoginAt        DateTime?

  customer Customer @relation(fields: [customerId], references: [id])
}

model RefreshToken {
  id         BigInt   @id @default(autoincrement())
  customerId BigInt
  tokenHash  String
  expiresAt  DateTime
  revokedAt  DateTime?
  createdAt  DateTime @default(now())

  customer Customer @relation(fields: [customerId], references: [id])
}

// CHANGED: RBAC staff users
model StaffUser {
  id           BigInt   @id @default(autoincrement())
  email        String   @unique
  passwordHash String
  role         String
  branchCode   String?
  fullName     String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  events Event[] @relation("EventCreatedBy") // CHANGED: staff creator relation
}

model Loan {
  id                        BigInt   @id @default(autoincrement())
  customerId                BigInt
  loanNo                    String   @unique
  externalLoanId            String?
  productName               String?
  loanCycle                 Int?
  principalAmount           Decimal
  interestRate              Decimal
  termInstallments          Int?
  disbursementDate          DateTime?
  maturityDate              DateTime?
  totalPrincipalOutstanding Decimal?
  totalInterestOutstanding  Decimal?
  lastSyncedAt              DateTime? // [BIJLI-LOAN] cache sync timestamp
  loanType                  String   @default("DEGRESSIVE") // [BIJLI-LOAN-RULE] BULLET/DEGRESSIVE
  status                    String   @default("ACTIVE")
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  customer     Customer          @relation(fields: [customerId], references: [id])
  installments LoanInstallment[]
}

model LoanInstallment {
  id            BigInt   @id @default(autoincrement())
  loanId        BigInt
  installmentNo Int
  dueDate       DateTime
  principalDue  Decimal
  interestDue   Decimal
  status        String   @default("PENDING")
  createdAt     DateTime @default(now())

  loan Loan @relation(fields: [loanId], references: [id])

  @@unique([loanId, installmentNo])
}

model CustomerSavings {
  id                BigInt   @id @default(autoincrement())
  customerId        BigInt
  type              String
  principalAmount   Decimal  @default(0)
  currentBalance    Decimal  @default(0)
  interestAccrued   Decimal  @default(0)
  lastDepositAmount Decimal?
  lastDepositDate   DateTime?
  importedAt        DateTime @default(now())

  customer Customer @relation(fields: [customerId], references: [id])

  @@unique([customerId, type])
}

model CustomerSavingsTransaction {
  id               BigInt   @id @default(autoincrement())
  customerId       BigInt
  savingsType      String
  trnDate          DateTime
  trnType          String
  depositAmount    Decimal  @default(0)
  withdrawalAmount Decimal  @default(0)
  externalKey      String   @unique
  createdAt        DateTime @default(now())

  customer Customer @relation(fields: [customerId], references: [id])

  @@index([customerId, savingsType, trnDate])
  // CHANGED: thêm bảng lưu lịch sử giao dịch tiết kiệm để phục vụ /savings
}

model Event {
  id          BigInt   @id @default(autoincrement())
  title       String
  description String?
  eventType   String
  startDate   DateTime
  endDate     DateTime?
  scope       String   @default("GLOBAL")
  groupCode   String?
  villageName String?
  branchCode  String   @default("UNKNOWN") // CHANGED: branch ownership for RBAC
  audienceType String @default("BRANCH_ALL") // CHANGED: BRANCH_ALL | GROUPS
  locationName String? // CHANGED: event location
  durationMinutes Int? // CHANGED: duration (minutes)
  createdByStaffId BigInt? // CHANGED: staff creator id
  importedAt  DateTime @default(now())

  createdByStaff StaffUser? @relation("EventCreatedBy", fields: [createdByStaffId], references: [id]) // CHANGED: staff creator
  targetGroups   EventTargetGroup[] // CHANGED: audience groups
}

// CHANGED: event target groups for GROUPS audience
model EventTargetGroup {
  id        BigInt @id @default(autoincrement())
  eventId   BigInt
  groupCode String
  groupName String?

  event Event @relation(fields: [eventId], references: [id])

  @@unique([eventId, groupCode])
  @@index([groupCode])
  @@index([eventId])
}

model Feedback {
  id           BigInt   @id @default(autoincrement())
  customerId   BigInt
  content      String
  createdAt    DateTime @default(now())
  status       String   @default("NEW")
  exportBatchId Int?

  customer Customer @relation(fields: [customerId], references: [id])
}

// NOTE: Them CustomerSavingsTransaction de luu lich su giao dich tu BIJLI va phuc vu /savings.
